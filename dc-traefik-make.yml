# Compose file odoo makeover y letsencrypt
# Version 2020-07-18
# Ojo hay que crear el /odoo_ar/traefik/acme.json y ponerle chmod 600

version: '3.5'

services:
  traefik:
    image: traefik:2.2.6
    container_name: traefik
    restart: unless-stopped
    command:
      - --entrypoints.web.address=:80
      - --entryPoints.websecure.address=:443
#      - --log.level=DEBUG
      - --providers.docker
      - --api.insecure # Don't do that in production
      - --api.debug

      - --certificatesresolvers.le.acme.email=jorge.obiols@gmail.com
      - --certificatesresolvers.le.acme.storage=/opt/traefik/acme.json
      - --certificatesresolvers.le.acme.httpChallenge=true
      - --certificatesresolvers.le.acme.httpChallenge.entryPoint=web
#      - --certificatesresolvers.le.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory # descoment for staging

    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /odoo_ar/traefik/:/opt/traefik/

  aeroo:
    image: jobiols/aeroo-docs
    container_name: aeroo

  netdata:
    container_name: netdata
    image: netdata/netdata
    hostname: odoo.makeoverlab.com.ar
    restart: unless-stopped
    ports: 
      - 19999:19999
    cap_add:
      - SYS_PTRACE
    security_opt:
      - apparmor:unconfined
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - netdatalib:/var/lib/netdata
      - netdatacache:/var/cache/netdata
      - /etc/passwd:/host/etc/passwd:ro
      - /etc/group:/host/etc/group:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /etc/os-release:/host/etc/os-release:ro
#    environment:
#      - VIRTUALIZATION=${VIRTUALIZATION}
    labels:
      # router rou-ndata --> Acceso a netdata en puerto 80
      - traefik.http.routers.rou-ndata.rule=Host(`odoo.makeoverlab.com.ar`)
      - traefik.http.routers.rou-ndata.entrypoints=web

      # Asigno los middlewares de redireccion a los routers  
      - traefik.http.routers.rou-ndata.middlewares=redirect-to-https@docker

      # Router rou-ndata-secure --> Acceso a ndata en puerto 443
      - traefik.http.routers.rou-ndata-secure.rule=Host(`odoo.makeoverlab.com.ar`)
      - traefik.http.routers.rou-ndata-secure.tls=true
      - traefik.http.routers.rou-ndata-secure.tls.certresolver=le
      - traefik.http.routers.rou-ndata-secure.entrypoints=websecure

      # redirecciona rout-ndata-secure al puerto 19999 donde ndata escucha
      - traefik.http.routers.rou-ndata-secure.service=srv-ndata-secure
      - traefik.http.services.srv-ndata-secure.loadbalancer.server.port=19999

volumes:
  netdatalib:
  netdatacache:
